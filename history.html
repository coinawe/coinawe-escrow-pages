<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Riwayat Transaksi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 1.5rem;
      color: #38bdf8;
    }
    select, input[type="text"] {
      background-color: #1e293b;
      color: #e2e8f0;
      border: 1px solid #334155;
      padding: 6px 12px;
      border-radius: 6px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .entry {
      background-color: #1e293b;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      animation: fadeIn 0.3s ease;
    }
    .entry b {
      color: #f0f9ff;
    }
    .status {
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .status.Completed {
      background-color: #22c55e;
      color: #0f172a;
    }
    .status.Pending {
      background-color: #facc15;
      color: #0f172a;
    }
    .status.Cancelled {
      background-color: #ef4444;
      color: #fff;
    }
    .footer {
      text-align: center;
      font-size: 0.85rem;
      margin-top: 20px;
      color: #94a3b8;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .pagination button {
      background-color: #1e293b;
      color: #e2e8f0;
      border: 1px solid #334155;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #back-home-button {
      display: inline-block;
      background-color: #1e293b;
      color: #e2e8f0;
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #334155;
      text-decoration: none;
      font-weight: bold;
      margin-top: 30px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <h2 id="page-title">üßæ Riwayat Escrow</h2>
    <select onchange="setLanguage(this.value)">
      <option value="id">üåê Bahasa</option>
      <option value="en">English</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    </select>
  </header>

  <div class="controls">
    <input type="text" id="search-input" placeholder="üîç Cari Buyer/Seller...">
    <select id="role-filter">
      <option value="">üîÅ Semua Peran</option>
      <option value="buyer">üë§ Hanya Buyer</option>
      <option value="seller">üè∑Ô∏è Hanya Seller</option>
    </select>
  </div>

  <div id="history">Memuat data...</div>
  <div class="pagination">
    <button onclick="prevPage()" id="prev-btn">‚¨Ö Prev</button>
    <button onclick="nextPage()" id="next-btn">Next ‚û°</button>
  </div>

  <div class="footer" id="footer-text">Menampilkan transaksi berdasarkan ID pengguna.</div>

  <div style="text-align:center;">
    <a href="https://escrow.coinawe.site" id="back-home-button">‚¨Ö Kembali ke Menu Utama</a>
  </div>

  <script>
    const translations = {
      id: {
        title: "üßæ Riwayat Escrow",
        loading: "Memuat data...",
        empty: "Tidak ada transaksi ditemukan.",
        failed: "Gagal memuat data transaksi.",
        buyer: "Pembeli",
        seller: "Penjual",
        amount: "Jumlah",
        item: "Item",
        status: "Status",
        footer: "Menampilkan transaksi berdasarkan ID pengguna.",
        back_home: "‚¨Ö Kembali ke Menu Utama",
        statuses: {
          Completed: "Selesai",
          Pending: "Menunggu",
          Cancelled: "Dibatalkan"
        }
      },
      en: {
        title: "üßæ Escrow History",
        loading: "Loading data...",
        empty: "No transactions found.",
        failed: "Failed to load transaction data.",
        buyer: "Buyer",
        seller: "Seller",
        amount: "Amount",
        item: "Item",
        status: "Status",
        footer: "Showing transactions based on user ID.",
        back_home: "‚¨Ö Back to Main Menu",
        statuses: {
          Completed: "Completed",
          Pending: "Pending",
          Cancelled: "Cancelled"
        }
      },
      ru: {
        title: "üßæ –ò—Å—Ç–æ—Ä–∏—è –≠—Å–∫—Ä–æ—É",
        loading: "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...",
        empty: "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
        failed: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.",
        buyer: "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å",
        seller: "–ü—Ä–æ–¥–∞–≤–µ—Ü",
        amount: "–°—É–º–º–∞",
        item: "–ü—Ä–µ–¥–º–µ—Ç",
        status: "–°—Ç–∞—Ç—É—Å",
        footer: "–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
        back_home: "‚¨Ö –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
        statuses: {
          Completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ",
          Pending: "–í –æ–∂–∏–¥–∞–Ω–∏–∏",
          Cancelled: "–û—Ç–º–µ–Ω–µ–Ω–æ"
        }
      }
    };

    let currentLang = 'id';
    let allData = [];
    let currentPage = 1;
    const pageSize = 10;

    const userId = new URLSearchParams(window.location.search).get("user_id") || "";
    const container = document.getElementById("history");
    const footer = document.getElementById("footer-text");

    function setLanguage(lang) {
      currentLang = lang;
      const t = translations[lang] || translations["en"];
      document.getElementById("page-title").innerText = t.title;
      footer.innerText = t.footer;
      document.getElementById("search-input").placeholder = "üîç " + t.buyer + "/" + t.seller;
      document.getElementById("role-filter").options[0].text = "üîÅ Semua Peran";
      document.getElementById("role-filter").options[1].text = "üë§ Hanya " + t.buyer;
      document.getElementById("role-filter").options[2].text = "üè∑Ô∏è Hanya " + t.seller;
      document.getElementById("back-home-button").innerText = t.back_home;
      container.innerText = t.loading;
      fetchData(t);
    }

    function fetchData(t) {
      fetch("https://script.google.com/macros/s/AKfycbywHuDI_p6ZrFJakBxZbCd4fhmc0sVeQj4vVQkSgOfP39XJXr9tbs7M0SL8VqpPjVyZ_w/exec?user_id=" + userId)
        .then(res => res.json())
        .then(data => {
          allData = data || [];
          currentPage = 1;
          renderData(t);
        })
        .catch(() => {
          container.innerHTML = `<p>${t.failed}</p>`;
        });
    }

    function filterData() {
      const q = document.getElementById("search-input").value.toLowerCase();
      const role = document.getElementById("role-filter").value;
      return allData.filter(row => {
        const matchSearch = (
          row.buyer_username.toLowerCase().includes(q) ||
          row.seller_username.toLowerCase().includes(q)
        );
        const matchRole = (
          role === "" ||
          (role === "buyer" && row.buyer_username.toLowerCase().includes(q)) ||
          (role === "seller" && row.seller_username.toLowerCase().includes(q))
        );
        return matchSearch && matchRole;
      });
    }

    function renderData(t) {
      const filtered = filterData();
      const start = (currentPage - 1) * pageSize;
      const pageData = filtered.slice(start, start + pageSize);

      if (filtered.length === 0) {
        container.innerHTML = `<p>${t.empty}</p>`;
        return;
      }

      container.innerHTML = "";
      pageData.forEach(row => {
        const statusClass = row.status;
        const statusLabel = t.statuses[row.status] || row.status;
        container.innerHTML += `
          <div class="entry">
            <b>${t.item}:</b> ${row.item}<br>
            <b>${t.amount}:</b> ${row.amount} ${row.token}<br>
            <b>${t.status}:</b> <span class="status ${statusClass}">${statusLabel}</span><br>
            <small><b>${t.buyer}:</b> ${row.buyer_username} ‚Ä¢ <b>${t.seller}:</b> ${row.seller_username}</small>
          </div>
        `;
      });

      document.getElementById("prev-btn").disabled = currentPage === 1;
      document.getElementById("next-btn").disabled = start + pageSize >= filtered.length;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderData(translations[currentLang]);
      }
    }

    function nextPage() {
      const filtered = filterData();
      if (currentPage * pageSize < filtered.length) {
        currentPage++;
        renderData(translations[currentLang]);
      }
    }

    document.getElementById("search-input").addEventListener("input", () => {
      currentPage = 1;
      renderData(translations[currentLang]);
    });

    document.getElementById("role-filter").addEventListener("change", () => {
      currentPage = 1;
      renderData(translations[currentLang]);
    });

    const browserLang = navigator.language.slice(0, 2);
    const defaultLang = ["id", "en", "ru"].includes(browserLang) ? browserLang : "en";
    setLanguage(defaultLang);
  </script>
</body>
</html>
